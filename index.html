<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CDC Planet Habitability</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>Welcome to CDC Planet Habitability</h1>
    <p>Explore exoplanets and their potential for life!</p>
  </header>

  <main>
    <section class="info">
      <h2>Habitable Zone Planets</h2>
      <table id="planet-table">
        <thead>
          <tr>
            <th class="sortable" data-key="Planet Name">Planet Name</th>
            <th class="sortable" data-key="Host name">Host Name</th>
            <th class="sortable" data-key="Distance [pc]">Distance (pc)</th>
            <th class="sortable" data-key="Planet radius (earth radius)">Radius (Earth)</th>
            <th class="sortable" data-key="Insolation Flux [Earth Flux]">Insolation Flux</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>© 2025 CDC Planet Habitability</p>
  </footer>

  <script>
  // Desktop-first version: Wikipedia hover + click pin + sorting

  let openTooltip = null;    // reference to tooltip element when pinned
  let openNameEl = null;     // reference to selected name span when pinned
  let sortState = {};        // track ascending/descending per column
  let planetsData = [];      // loaded data

  // create tooltip element appended to body
  const tooltip = document.createElement('div');
  tooltip.className = 'tooltip';
  document.body.appendChild(tooltip);

  // fetch wiki summary (REST v1) for a page name
  async function fetchWikiSummary(name) {
    const page = encodeURIComponent(name.replace(/\s+/g, '_'));
    try {
      const res = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${page}`);
      if (!res.ok) return null;
      const json = await res.json();
      return json;
    } catch {
      return null;
    }
  }

  // attach hover/click events for a planet name span
  function attachTooltipEvents(nameSpan, planet) {
    let wikiCache = null;

    async function loadAndShow() {
      tooltip.innerHTML = '<em>Loading…</em>';
      positionTooltip(nameSpan);
      tooltip.style.display = 'block';

      if (!wikiCache) wikiCache = await fetchWikiSummary(nameSpan.dataset.name);
      if (wikiCache && wikiCache.extract) {
        tooltip.innerHTML = `
          <strong>${escapeHtml(wikiCache.title || nameSpan.dataset.name)}</strong>
          ${wikiCache.thumbnail ? `<div><img src="${escapeAttr(wikiCache.thumbnail.source)}" alt="${escapeAttr(wikiCache.title)}" /></div>` : ''}
          <div class="tooltip-text">${escapeHtml(wikiCache.extract)}</div>
        `;
      } else {
        // fallback: show some planet fields if wiki missing
        tooltip.innerHTML = `
          <strong>${escapeHtml(planet["Planet Name"] || nameSpan.dataset.name)}</strong>
          <div class="tooltip-text">
            Host: ${escapeHtml(planet["Host name"] || '')}<br>
            Distance: ${escapeHtml(String(planet["Distance [pc]"] || ''))} pc<br>
            Radius: ${escapeHtml(String(planet["Planet radius (earth radius)"] || ''))} R⊕<br>
            Insolation: ${escapeHtml(String(planet["Insolation Flux [Earth Flux]"] || ''))}
          </div>
        `;
      }
    }

    // Hover: only show if not pinned
    nameSpan.addEventListener('mouseenter', async () => {
      if (openNameEl !== nameSpan) {
        await loadAndShow();
      }
    });

    nameSpan.addEventListener('mouseleave', () => {
      if (openNameEl !== nameSpan) {
        tooltip.style.display = 'none';
      }
    });

    // Click: pin/unpin
    nameSpan.addEventListener('click', async (e) => {
      e.stopPropagation();
      // if another pinned, unpin it
      if (openTooltip && openTooltip !== tooltip) {
        // nothing extra needed, we only have one tooltip instance
      }
      if (openNameEl === nameSpan) {
        // unpin
        openNameEl.classList.remove('selected');
        openNameEl = null;
        openTooltip = null;
        tooltip.style.display = 'none';
      } else {
        // pin this
        if (openNameEl) openNameEl.classList.remove('selected');
        openNameEl = nameSpan;
        openNameEl.classList.add('selected');
        openTooltip = tooltip;
        await loadAndShow();
      }
    });
  }

  // position tooltip below element using getBoundingClientRect + scroll offsets
  function positionTooltip(el) {
    const rect = el.getBoundingClientRect();
    const top = window.scrollY + rect.bottom + 6;
    const left = window.scrollX + rect.left;
    tooltip.style.top = `${top}px`;
    tooltip.style.left = `${left}px`;
  }

  // utility: escape html/text for insertion
  function escapeHtml(s) {
    if (s === undefined || s === null) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }
  function escapeAttr(s) {
    if (s === undefined || s === null) return '';
    return String(s).replace(/"/g, '&quot;');
  }

  // build/rebuild table rows from planetsData
  function buildTable(data) {
    const tbody = document.querySelector('#planet-table tbody');
    tbody.innerHTML = '';
    data.forEach(planet => {
      const tr = document.createElement('tr');

      const nameTd = document.createElement('td');
      const nameSpan = document.createElement('span');
      nameSpan.className = 'planet-name';
      nameSpan.textContent = planet['Planet Name'] || 'Unknown';
      nameSpan.dataset.name = planet['Planet Name'] || '';
      nameTd.appendChild(nameSpan);
      attachTooltipEvents(nameSpan, planet);
      tr.appendChild(nameTd);

      const cols = [
        'Host name',
        'Distance [pc]',
        'Planet radius (earth radius)',
        'Insolation Flux [Earth Flux]'
      ];
      cols.forEach(k => {
        const td = document.createElement('td');
        td.textContent = (planet[k] !== undefined && planet[k] !== null) ? planet[k] : '';
        tr.appendChild(td);
      });

      tbody.appendChild(tr);
    });
  }

  // Sorting handler (click on header)
  function enableSorting() {
    document.querySelectorAll('#planet-table th.sortable, #planet-table th').forEach(th => {
      // ensure sortable class exists for the ones with data-key
      const key = th.dataset.key || th.getAttribute('data-column') || null;
      if (!key) return; // no data key; skip
      th.classList.add('sortable'); // ensure style

      th.addEventListener('click', () => {
        const ascending = !sortState[key];
        sortState[key] = ascending;

        planetsData.sort((a, b) => {
          const A = a[key];
          const B = b[key];

          // Attempt numeric compare
          const nA = parseFloat(String(A).replace(/[^0-9eE\.\-+]/g, ''));
          const nB = parseFloat(String(B).replace(/[^0-9eE\.\-+]/g, ''));
          if (!Number.isNaN(nA) && !Number.isNaN(nB)) {
            return ascending ? nA - nB : nB - nA;
          }

          const sA = String(A || '').toLowerCase();
          const sB = String(B || '').toLowerCase();
          if (sA < sB) return ascending ? -1 : 1;
          if (sA > sB) return ascending ? 1 : -1;
          return 0;
        });

        // update header indicators
        document.querySelectorAll('#planet-table th').forEach(h => {
          h.classList.remove('asc','desc');
        });
        th.classList.add(ascending ? 'asc' : 'desc');

        buildTable(planetsData);
      });
    });
  }

  // load data then build
  fetch('hz_planets.json')
    .then(r => r.json())
    .then(json => {
      planetsData = Array.isArray(json) ? json : [];
      buildTable(planetsData);
      enableSorting();
    })
    .catch(err => {
      console.error('failed to load hz_planets.json', err);
    });

  // clicking outside closes pinned tooltip
  document.addEventListener('click', (e) => {
    if (openNameEl && !e.target.closest('.planet-name')) {
      openNameEl.classList.remove('selected');
      openNameEl = null;
      openTooltip = null;
      tooltip.style.display = 'none';
    }
  });

  // reposition tooltip for pinned element on scroll
  window.addEventListener('scroll', () => {
    if (openNameEl) positionTooltip(openNameEl);
  });

  </script>
</body>
</html>